<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Segmentation Stream</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 24px; }
      .frame { max-width: 100%; border: 1px solid #ddd; border-radius: 8px; }
      .meta { color: #555; margin-bottom: 12px; line-height: 1.35; }
      h2 { margin-top: 0; }
      .kvm { display: grid; grid-template-columns: repeat(3, max-content); gap: 12px 24px; align-items: baseline; }
      .kvm b { color: #222; }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    </style>
  </head>
  <body>
    <h2>Semantic Segmentation â€” MJPEG Stream</h2>

    <div class="meta kvm">
      <div><b>Model:</b></div><div class="mono" id="model">{{ model }}</div><div></div>
      <div><b>Source:</b></div><div class="mono">{{ src }}</div><div></div>
      <div><b>Device:</b></div><div class="mono">{{ device }}</div><div></div>
      <div><b>Output width:</b></div><div class="mono">{{ width }} px</div><div></div>
      <div><b>PyTorch:</b></div><div class="mono">{{ torch_ver }}</div><div></div>
      <div><b>torchvision:</b></div><div class="mono">{{ tv_ver }}</div><div></div>

      <div><b>Frames:</b></div><div class="mono" id="frames">0</div><div></div>
      <div><b>Latency (model, EMA):</b></div><div class="mono" id="lat_model">0 ms</div><div></div>
      <div><b>Latency (e2e, EMA):</b></div><div class="mono" id="lat_e2e">0 ms</div><div></div>
      <div><b>Throughput (pipeline, EMA):</b></div><div class="mono" id="fps">0 FPS</div><div></div>
    </div>

    <img class="frame" src="/video" alt="Segmentation stream" />

    <script>
      async function pollMetrics(){
        try{
          const r = await fetch('/metrics', {cache:'no-store'});
          if(!r.ok) throw new Error('bad status');
          const m = await r.json();
          document.getElementById('frames').textContent = m.frames;
          document.getElementById('lat_model').textContent = m.latency_model_ms + ' ms';
          document.getElementById('lat_e2e').textContent = m.latency_e2e_ms + ' ms';
          document.getElementById('fps').textContent = m.fps_pipeline + ' FPS';
          if (m.model) document.getElementById('model').textContent = m.model;
        }catch(e){
          /* ignore */
        }finally{
          setTimeout(pollMetrics, 1000);
        }
      }
      pollMetrics();
    </script>
  </body>
</html>

